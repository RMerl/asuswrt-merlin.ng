#!/bin/bash

export LD_LIBRARY_PATH=$HOSTTOOLS_DIR/libelf/lib:$LD_LIBRARY_PATH 
source $KERNEL_DIR/.config

TARGETS_DIR=`pwd`

if [ "$INSTALL_DIR" == "" ]; then
    INSTALL_DIR=./$PROFILE/fs.install
fi

if [ -d $PROFILE/fs ]; then
  ROOTFS=$PROFILE/fs
else # Alternative path for DESKTOP_LINUX
  ROOTFS=$PROFILE/fs.install
fi

USERSPACE_DL_MODULES_BEEP_DIR=$BUILD_DIR/userspace/dlModules/beep
EEMNGR_DIR=$BUILD_DIR/userspace/private/apps/exampleEE
USERSPACE_DL_MODULES_EEMNGR_DIR=$EEMNGR_DIR/exampleEEDir

if [ "$ARCH" == "arm64" ]; then
	LIBDIR_NAME="lib64"
else
	LIBDIR_NAME="lib"
fi

#construct EXAMPLEEE base filesystem
echo "construct EXAMPLEEE base filesystem"
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/data
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/dev
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/etc/data
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/lib
if [ "$ARCH" == "arm64" ]; then
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/lib64
fi
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/local
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/mnt
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/proc
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/sbin
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/sys
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/tmp
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/usr/bin
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/usr/sbin
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/var
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/libexec
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/run
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/share
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/include
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/opt
mkdir -p $USERSPACE_DL_MODULES_EEMNGR_DIR/du

#change etc directory mode to 777 so that passwd file can be created.
chmod 777 $USERSPACE_DL_MODULES_EEMNGR_DIR/etc

cp -av $TARGETS_DIR/$ROOTFS/bin/busybox $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/dhcpclient $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/bash $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/cat $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/cp $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/echo $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/ip $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/kill $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/ln $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/ls $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/mkdir $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/mknod $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/mount $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/ping $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/ps $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/pwd $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/rm $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/sh $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/sleep $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/tar $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/umount $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $TARGETS_DIR/$ROOTFS/bin/uname $USERSPACE_DL_MODULES_EEMNGR_DIR/bin

cp -av $TARGETS_DIR/$ROOTFS/usr/bin/timeout $USERSPACE_DL_MODULES_EEMNGR_DIR/usr/bin
cp -av $TARGETS_DIR/$ROOTFS/usr/bin/dbus* $USERSPACE_DL_MODULES_EEMNGR_DIR/usr/bin
cp -av $TARGETS_DIR/$ROOTFS/usr/bin/du $USERSPACE_DL_MODULES_EEMNGR_DIR/usr/bin
cp -av $TARGETS_DIR/$ROOTFS/usr/bin/glib* $USERSPACE_DL_MODULES_EEMNGR_DIR/usr/bin
cp -av $TARGETS_DIR/$ROOTFS/usr/bin/gdbu* $USERSPACE_DL_MODULES_EEMNGR_DIR/usr/bin
cp -av $TARGETS_DIR/$ROOTFS/usr/bin/busybox $USERSPACE_DL_MODULES_EEMNGR_DIR/usr/bin

cp -av $TARGETS_DIR/$ROOTFS/sbin/init $USERSPACE_DL_MODULES_EEMNGR_DIR/sbin
cp -av $TARGETS_DIR/$ROOTFS/sbin/init.lxc $USERSPACE_DL_MODULES_EEMNGR_DIR/sbin

cp -av $TARGETS_DIR/$ROOTFS/lib/ld-linux* $USERSPACE_DL_MODULES_EEMNGR_DIR/lib
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libc.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libcrypt.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libcrypto.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libdbus-1.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libdl.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libexpat.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libffi.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libgcc_s.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libgio-2.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libglib-2.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libgmodule-2.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libgobject-2.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libgthread-2.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libjson-c.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/liblxc.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libm.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libnss*.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libpthread.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libresolv.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/librt.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libutil.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libz.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libssl.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libsqlite* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libcurl* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libnghttp2* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME
cp -av $TARGETS_DIR/$ROOTFS/$LIBDIR_NAME/libseccomp.* $USERSPACE_DL_MODULES_EEMNGR_DIR/$LIBDIR_NAME

cp -av $EEMNGR_DIR/exampleEE $USERSPACE_DL_MODULES_EEMNGR_DIR/bin
cp -av $EEMNGR_DIR/config $USERSPACE_DL_MODULES_EEMNGR_DIR/etc

tar zcf exampleEE.tar.gz -C $USERSPACE_DL_MODULES_EEMNGR_DIR .
mv exampleEE.tar.gz $USERSPACE_DL_MODULES_EEMNGR_DIR

cd $EEMNGR_DIR
cp -av ./exampleEE.manifest $USERSPACE_DL_MODULES_EEMNGR_DIR
$HOSTTOOLS_DIR/beep/beepPkgBuilder -f ./exampleEE-pkginfo.txt

mv ./pkg_beep_*_*.tar.gz $USERSPACE_DL_MODULES_BEEP_DIR
$HOSTTOOLS_DIR/beep/reposcan -d $USERSPACE_DL_MODULES_BEEP_DIR
rm -rf $USERSPACE_DL_MODULES_EEMNGR_DIR

