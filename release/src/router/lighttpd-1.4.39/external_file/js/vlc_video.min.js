var m=new lang,g_storage=new myStorage,g_this_url="",g_this_video="",g_this_video_name="",g_this_video_hash="",g_play_id=-1,g_subtitle_timer=0,g_isIE=!1,g_video_player_type="none";
function detectVLCInstalled(){navigator.userAgent.toLowerCase();var a=!1;if(g_isIE){var b=null;try{b=new ActiveXObject("VideoLAN.Vlcplugin")}catch(c){var d="An exception occurred while trying to create the object VideoLAN.VLCPlugin.1:\n";for(p in c)d+="e."+p+"= "+c[p]+"\n"}null!=b&&(a=!0)}else if(navigator.plugins&&navigator.plugins.length)for(b=0;b<navigator.plugins.length;b++)if(d=navigator.plugins[b],d.name.indexOf("VideoLAN")>-1||d.name.indexOf("VLC")>-1)a=!0;return a}
function getInternetExplorerVersion(){var a=-1;navigator.appName=="Microsoft Internet Explorer"&&/MSIE ([0-9]{1,}[.0-9]{0,})/.exec(navigator.userAgent)!=null&&(a=parseFloat(RegExp.$1));return a}function closeWindow(){parent.closeJqmWindow(0)}$(document).keydown(function(a){if(a.keyCode==27)return!1});function init(){setTimeout(function(){createPlayer()},500)}
function monitor(){if(getPlayer("videoPlayer")!=null){var a=getCurrentTime(),b=getTotalTime();g_video_player_type=="vlc"&&a>=b&&doStop();b>0&&($(".currTime").text(formatTime(a)),$(".totalTime").text(formatTime(b)),a=a/b*$(".playbar .slider-tracker").width(),$(".playbar .slider-thumb").css("left",a),$(".playbar .slider-progress").css("width",a));record_playtime()}}
function formatTime(a){if(typeof a!="number")return"-:--:--";var a=Math.round(a),b=a%60;b<10&&(b="0"+b);var a=(a-b)/60,c=a%60;c<10&&(c="0"+c);a=(a-c)/60;return a>0?a+":"+c+":"+b:c+":"+b}function getCurrentTime(){var a=getPlayer("videoPlayer");if(a==null)return 0;var b=0;g_video_player_type=="html5"?b=a.currentTime:g_video_player_type=="vlc"&&(b=a.input.time/1E3);return b}
function getTotalTime(){var a=getPlayer("videoPlayer");if(a==null)return 0;var b=0;g_video_player_type=="html5"?b=a.duration:g_video_player_type=="vlc"&&(b=a.input.length/1E3);return b}function doPlay(){var a=getPlayer("videoPlayer");a!=null&&(g_video_player_type=="html5"?(a.play(),$("#btn_play").hide(),$("#btn_pause").show()):g_video_player_type=="vlc"&&(a.playlist.play(),$("#btn_play").hide(),$("#btn_pause").show()))}
function doPause(){var a=getPlayer("videoPlayer");a!=null&&(g_video_player_type=="html5"?(a.pause(),$("#btn_play").show(),$("#btn_pause").hide()):g_video_player_type=="vlc"&&(g_isIE?a.playlist.stop():a.playlist.pause(),$("#btn_play").show(),$("#btn_pause").hide()))}
function doStop(){var a=getPlayer("videoPlayer");a!=null&&(g_video_player_type=="html5"?(a.pause(),$("#btn_play").show(),$("#btn_pause").hide()):g_video_player_type=="vlc"&&(a.playlist.stop(),$("#btn_play").show(),$("#btn_pause").hide()))}function record_playtime(){var a=getCurrentTime(),b=getTotalTime();a>=b?g_storage.setl(g_this_video_hash,0):g_storage.setl(g_this_video_hash,a)}
function doAspectRatio(){var a=getPlayer("videoPlayer");if(a!=null&&g_video_player_type!="html5"&&g_video_player_type=="vlc")a.video.aspectRatio=$("#select_aspect").val()}
function play_subtitle(){getPlayer("videoPlayer")!=null&&$(".srt").each(function(){var a=function(a){var b=0;if(a){a=a.split(":");for(i=0;i<a.length;i++)b=b*60+parseFloat(String(a[i]==null?"":a[i]).replace(",","."))}return b},b=function(a){return String(a==null?"":a).replace(/^\s+|\s+$/g,"")},c=function(a){var b=[],c;for(c in a)b.push(c);b.sort();c=[];for(var g=0;g<b.length;g++)c[b[g]]=a[b[g]];return c},d=function(d){var h=d.text();d.text("");var h=h.replace(/\r\n|\r|\n/g,"\n"),k={},h=String(b(h)),
g=1,h=h.split("\n\n");for(s in h)if(st=String(h[s]).split("\n"),st.length>=2){n=st[0];i=b(st[1].split(" --\> ")[0]);o=b(st[1].split(" --\> ")[1]);t=st[2];if(st.length>2)for(j=3;j<st.length;j++)t+="\n"+st[j];is=a(i);os=a(o);k[g]={is:is,i:i,o:o,t:t};g++}k=c(k);k.length>0&&($(".subtitle").show(),adjustVideoSize());var q=-1;g_subtitle_timer=setInterval(function(){var a=getCurrentTime(),b=-1,c;for(c in k){if(k[c].is>a)break;b=c}b>0?b!=q?(d.text(k[b].t),q=b):k[b].o<a&&d.text(""):d.text("")},100)},e=$(this);
clearInterval(g_subtitle_timer);var f=e.attr("data-srt");f?$(this).load(f,function(){d(e)}):(e.text(""),$(".subtitle").hide(),adjustVideoSize())})}function adjustVideoSize(){var a=getPlayer("videoPlayer");if(a!=null){var b=$(window).width(),c=$(window).height();$(".toolbar").is(":visible")&&(c-=$(".toolbar").height());$(".footer").is(":visible")&&(c-=$(".footer").height());$(".subtitle").is(":visible")&&(c-=$(".subtitle").height());a.style.width=b+"px";a.style.height=c+"px"}}
function getPlayer(a){return document.getElementById(a)}
function initPlayer(){var a=getPlayer("videoPlayer");if(a!=null){var b=typeof getUrlVar("s")=="undefined"?"":getUrlVar("s");if(b!=""){for(var b=b.split(";"),c=!1,d="<option value=''>"+m.getString("title_no_subtitle")+"</option>",e=0;e<b.length;e++){var f=b[e];if(f!=""){var f=f.substr(f.lastIndexOf("/")+1,f.length),l=window.location.protocol+"//"+window.location.host+b[e];d+="<option value='"+l+"'";f.indexOf(g_this_video_name)==0&&(d+="selected ",$(".subtitle").attr("data-srt",l));d+=">"+f+"</option>";
c=!0}}$(d).appendTo($("#select_subtitle"));$(".subtitle-ctrl").css("display",c?"block":"none");$("#select_subtitle").change(function(){$(".subtitle").attr("data-srt",$(this).val());play_subtitle()});play_subtitle()}else c=!1,d="<option value=''>"+m.getString("title_no_subtitle")+"</option>",b=new davlib.DavClient,b.initialize(),e=g_this_url!=""?g_this_url:g_this_video.substring(0,g_this_video.lastIndexOf("/")+1),b.GETVIDEOSUBTITLE(e,g_this_video_name,function(a,b,g){a==200&&(a=parseXml(g),$(a).find("file").each(function(){var a=
$(this).find("name").text(),b=window.location.protocol+"//"+window.location.host+"/"+$(this).find("sharelink").text();d+="<option value='"+b+"'";a.indexOf(g_this_video_name)==0&&(d+="selected ",$(".subtitle").attr("data-srt",b));d+=">"+a+"</option>";c=!0}),$(d).appendTo($("#select_subtitle")),$(".subtitle-ctrl").css("display",c?"block":"none"),$("#select_subtitle").change(function(){$(".subtitle").attr("data-srt",$(this).val());play_subtitle()}),play_subtitle())}),b=null;if(g_video_player_type=="html5")$("#videoPlayer").on("ended",
function(){doStop()});else if(g_video_player_type=="vlc"){if(g_play_id=a.playlist.add(g_this_video),g_play_id==-1){alert("cannot play at the moment !");return}}else{alert("Not supported player");return}b=parseInt($(".volumebar .slider-progress").css("left"));$(".volumebar .slider-thumb").css("left",37);$(".volumebar .slider-progress").css("width",37-b);doPlay();setInterval("monitor()",1E3);b=g_storage.getl(g_this_video_hash);if(b!=void 0&&b!=0&&confirm(m.getString("msg_last_playtime")))if(g_video_player_type==
"html5")a.currentTime=b;else if(g_video_player_type=="vlc")a.input.time=b*1E3;$(".toolbar").show();$(".footer").show();adjustVideoSize();$("#btn_play").click(function(){doPlay()});$("#btn_pause").click(function(){doPause()});$("#btn_stop").click(function(){doStop()});$(".playbar .slider-thumb").draggable({axis:"x",snap:"true",cursor:"move",start:function(){},drag:function(a,b){var c=$(".playbar .slider-tracker").width();if(b.position.left<=0)b.position.left=0;if(b.position.left>=c)b.position.left=
c;$(".playbar .slider-progress").css("width",b.position.left)},stop:function(b,c){var d=getTotalTime(),e=0;d>0&&(e=c.position.left/$(".playbar .slider-tracker").width()*d);if(g_video_player_type=="html5")a.currentTime=e,a.play();else if(g_video_player_type=="vlc")a.input.time=e*1E3,a.playlist.play()}});$(".volumebar .slider-thumb").draggable({axis:"x",snap:"true",cursor:"move",drag:function(b,c){var d=parseInt($(".volumebar .slider-progress").css("left")),e=74-$(".volumebar .slider-thumb").width()+
d;if(c.position.left<=d)c.position.left=d;if(c.position.left>=e)c.position.left=e;$(".volumebar .slider-progress").css("width",c.position.left-d);if(g_video_player_type=="html5")d=c.position.left/74,a.volume=d;else if(g_video_player_type=="vlc")d=c.position.left/74*200,a.audio.volume=d},stop:function(b,c){if(g_video_player_type=="html5"){var d=c.position.left/74;a.volume=d}else if(g_video_player_type=="vlc")d=c.position.left/74*200,a.audio.volume=d}})}}
function createPlayer(){var a=String(window.navigator.userLanguage||window.navigator.language).toLowerCase(),a=g_storage.get("lan")==void 0?a:g_storage.get("lan");m.setLanguage(a);$("button#btnClose").text(m.getString("btn_close"));$("#label_subtitle").text(m.getString("title_subtitle_file")+": ");var b=typeof getUrlVar("u")=="undefined"?"":getUrlVar("u"),a=getUrlVar("v"),c="";g_this_url=b;g_this_video=a;g_this_video_name=a.substring(a.lastIndexOf("/")+1,a.lastIndexOf("."));g_this_video_hash=md5(g_this_video.substr(g_this_video.lastIndexOf("/")+
1,g_this_video.length));navigator.userAgent.toLowerCase();var b=navigator.appVersion.toLowerCase(),d=g_this_video.split(".").pop().toLowerCase();g_isIE=isIE();if(b.indexOf("mac")!=-1||d=="mp4")b=$(window).width(),d=$(window).height()-$(".footer").height(),c+="<div>",c+="<video id='videoPlayer' name='videoPlayer' width='"+b+"px' height='"+d+"px' autoplay>",c+="<source src='",c+=a,c+="' type='video/mp4'/>",c+="Your browser does not support the video tag.",c+="</video>",c+="</div>",g_video_player_type=
"html5";else if(g_isIE){if(!detectVLCInstalled()){b=$(window).width();d=$(window).height()-$(".footer").height();c+="<div id='errorpage' class='section' style='width:"+b+"px; height:"+d+"px'>";c+="<img id='errorpage_bg' src='vlc_bg_img.jpg'/>";c+="<p style='position:relative;left:54px;top:60px;width:500px;font-size:20px;color:#ffffff'>"+m.getString("msg_installvlc")+"</p>";c+="<p style='position:relative;left:54px;top:80px;width:550px;font-size:16px;color:#ffffff;text-align:left'>"+m.getString("msg_installvlc2")+
"</p>";c+="<p style='position:relative;left:216px;top:100px;width:350px;font-size:14px;color:#ffffff;text-align:left'>"+m.getString("msg_installvlc3")+"</p>";c+="<a href='http://www.videolan.org/vlc/' target='_blank'><div style='width:123px;height:30px;background-image:url(downloadvlc.png);position:relative;left:456px;top:100px;cursor:pointer'></div></a>";c+="</div>";$(c).appendTo($(".videoplayer"));$(".subtitle").hide();$(".footer").show();return}c+="<div>";g_isIE?(c+="<OBJECT classid='clsid:9BE31822-FDAD-461B-AD51-BE1D1C159921'",
c+=" codebase='http://download.videolan.org/pub/videolan/vlc/last/win32/axvlc.cab'",c+=" id='videoPlayer' name='videoPlayer' width='655px' height='470px' events='True'>",c+="<param name='MRL' value='' />",c+="<param name='ShowDisplay' value='False'/>",c+="<param name='AutoLoop' value='False'/>",c+="<param name='AutoPlay' value='False'/>",c+="<param name='ToolBar' value='False'/>",c+="<param name='Volume' value='50' />",c+="<param name='StartTime' value='0' />",c+="</OBJECT>"):(c+="<embed type='application/x-vlc-plugin'",
c+=" pluginspage='http://www.videolan.org'",c+=" width='655px' height='470px' id='videoPlayer' name='videoPlayer' version='VideoLAN.VLCPlugin.2' text='Waiting for video' Volume='50' toolbar='False' AutoPlay='False'/>");c+="</div>";g_video_player_type="vlc"}else{alert("Can not play this video!");return}$(c).appendTo($("#video_player_section"));$(".subtitle").hide();$(".footer").show();initPlayer()};
