<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0,  user-scalable=no" />
    </head>

    <body>
        <div class="d-flex align-items-center mb-3">
            <div class="page-title"><#Settings#></div>
        </div>
		<div class="row">
            <div class="col-12 mb-3">
				<div class="card card-cut-none pt-2 h-100">
					<iframe id="settingsWindow" style="width: 100%; height: 100vh;" src="/Advanced_Default_Content.asp"></iframe>
				</div>
			</div>
        </div>
	</body>

	<script>
		var webWrapper = true;
		var targetPage = urlParameter.get("tab");
        if (targetPage === "" || targetPage === undefined || targetPage == null) {
			const lastSettingsPage = top.Session.get("settings-lastPage") || "";
            const isValidPage = lastSettingsPage && lastSettingsPage !== "index.html" && lastSettingsPage.includes(".");
            targetPage = isValidPage ? lastSettingsPage : "Tools_Sysinfo.asp";
		} else {
            const state = null;
            const title = "";
            const newUrl = "index.html";
            history.replaceState(state, title, newUrl);
		}
		var currentPage = $('#settingsWindow').attr('src').replace("/", "");
        if (currentPage != targetPage) $('#settingsWindow').attr({'src': "/" + targetPage})

		var findColorAndReplace = function(styleSheet, oldColor, newColor){
			function hexToRgb(hex) {
				var result;

				result = /([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
				var retData = result ? [
					parseInt(result[1], 16),
					parseInt(result[2], 16),
					parseInt(result[3], 16)
				] : null;

				return retData ? retData.join(", ") : false;
			}

			$("#settingsWindow").contents().find('*').filter(function(){
				var getElement = $(this).css(styleSheet) || "";

				if(getElement.indexOf(hexToRgb(oldColor)) != -1){
					var targetStyleSheet = (oldColor == "FFCC00") ? {"font-size": "13px"} : {}
					var originStyle = $(this).css(styleSheet);

					if(originStyle){
						targetStyleSheet[styleSheet] = (newColor != "transparent") ? originStyle.replace(hexToRgb(oldColor), hexToRgb(newColor)) : "transparent";
					}

					$(this).css(targetStyleSheet)

				}
			})
		}

		function setupWrapper(){
			if(document.querySelector("#settingsWindow").contentWindow.document.body == null) return false;

			var iframe = $("#settingsWindow").contents();
			iframe.find(".formfonttitle").parent().addClass("p-0 m-0");

			// top banner
			iframe.find("#TopBanner").hide()

			// menutree
			iframe.find(".menu_Split").hide();
			iframe.find(".menu_Split").first().show();
			iframe.find("#mainMenu").parent().addClass("bg-shadow-right");
			iframe.find("#tabMenu").parent().addClass("p-tabMenu");

			// iframe.find(".menu_Split")[0].show()
			iframe.find("#QIS_wizard_menu").remove()
			iframe.find("#index_menu").remove()
			iframe.find("#index_menu").remove()
			iframe.find("#SDN_menu").remove()
			iframe.find("#AiMesh_menu").remove()
			iframe.find("#cloud_main_menu").remove()
			iframe.find("#AiProtection_HomeProtection_menu").remove()
//			iframe.find("#TrafficAnalyzer_Statistic_menu").remove()
			iframe.find("#Guest_network_menu").remove()
			iframe.find("#Advanced_Smart_Home_Alexa_menu").remove()
			iframe.find("#Advanced_VPNServer_Content_menu").remove()
			// submenu
			iframe.find("#tabMenu").parent().css({"text-align": "center"})
			iframe.find("#tabMenu table").css({
				"width": "100%",
				"border-spacing": "0px"
			})
			iframe.find(".tab").parent().css({"border-bottom": "solid 4px #dcdcdc"})
			iframe.find(".tabClicked").parent().css({"border-bottom": "solid 4px var(--primary-70)"})
			iframe.find("#FormTitle").attr({"width": "100%"})
			iframe.find('#whiteThemeWrapper table').attr('width', '100%');
			iframe.find('td[width="17"]').remove();
			iframe.find('td[width="20"]').remove();
			iframe.find('td[width="10"]').remove();
			iframe.find(".formfonttitle").hide()
			iframe.find(".splitLine").hide()
			iframe.find(".button_gen_dis").removeClass("button_gen_dis").addClass("button_gen")
			iframe.find(".hint-color").removeClass("hint-color").addClass("warning_desc")

			// footer
			iframe.find("#footer").hide();
			iframe.find('.bg-shadow-right').on('click', function(){
				if($(this).css('position') == "absolute") $(this).hide();
			});
		}

		function setupBusinessUI(){
			var iframe = $("#settingsWindow").contents();

			findColorAndReplace("color", "FFFFFF", "006CE1");
			findColorAndReplace("color", "FFCC00", "006CE1");
			setTimeout(function(){findColorAndReplace("color", "FFCC00", "e10000");}, 500);

			findColorAndReplace("background-color", "475A5F", "transparent");
			findColorAndReplace("background-color", "4D595D", "transparent");

			if(theme.toLocaleUpperCase() == "WHITE"){
				iframe.find('link').last().after('<link group="extend_css" rel="stylesheet" type="text/css" href="/RWD_UI/rwd_component_' + theme.toLocaleUpperCase() + '.css">');
			}

			iframe.find("#FormTitle").parent().parent().parent().parent()
				.wrap( "<div id='whiteThemeWrapper'></div>")

			setupWrapper();
			setTimeout(function(){
				iframe.find("body").hide().css("visibility", "visible").fadeIn();
			}, 1);

			iframe.find("body").addClass("scaleBody");

			iframe.find("#tabMenu table:first tr:first").prepend(`
				<td id="menu_setting">
					<div class="tabClicked">
						<div id="tabMoreIcon"></div>
					</div>
				</td>
			`);

			iframe.find("#menu_setting").on('click', function(){
				var settingsMenu = $("#settingsWindow").contents().find('.bg-shadow-right');

				if (settingsMenu.is(':visible')) {
					settingsMenu.hide();
					$("#settingsWindow").contents().find('.tab').hide();
				} else {
					settingsMenu.show()
					$("#settingsWindow").contents().find('.tab').show();
					$("#settingsWindow").contents().find(".bg-shadow-right").css({
						"top": `${$("#settingsWindow").contents().find(".submenuBlock").height()+10}px`
					});
				}
			});
		}

		var iframeHandler = {
			element: document.getElementById('settingsWindow'),
			defaultPage: "/Advanced_Wireless_Content.asp",
			
			onLoad: function() {
				if (top.loader?.isShow?.()) {
					top.loader.hide();
					top.loader = null;
				}
			},
			
			onError: function() {
				httpApi.log("SETTING_WINDOW LOAD ERROR", this.src);
				this.src = iframeHandler.defaultPage;
			},
			
			checkContent: function() {
				try {
					var doc = this.contentDocument || this.contentWindow.document;
					if (doc?.readyState === 'complete') {
						var title = doc.title.toLowerCase();
						if (/404|not found|error/.test(title)) {
							httpApi.log("SETTING_WINDOW LOAD ERROR", this.src);
							this.src = iframeHandler.defaultPage;
						}
					}
				} catch (e) {
                    httpApi.log("SETTING_WINDOW LOAD ERROR", this.src, e);
                }
			},
			
			init: function() {
				this.element.onload = this.onLoad;
				this.element.onerror = this.onError;
				this.element.addEventListener('load', this.checkContent);
			}
		};
		
		iframeHandler.init();
		
		window.addEventListener('message', event => {
			if (event.data.type === 'resize') {
				const iframe = document.getElementById('settingsWindow');
				if (iframe) {
                    const footer = (navigator.userAgent.match(/ASUSMultiSiteManager/) || navigator.userAgent.match(/ASUSExpertSiteManager/)) ? 100 : 20;
                    const iframeHeight = event.data.height + footer;
					const remHeight = 16;
					const headerHeight = document.querySelector('header')?.scrollHeight || 0;
					const paddinHeight = remHeight * 2;
					const pageTitleHeight = document.querySelector('.page-title')?.scrollHeight || 0;
					const footerHeight = remHeight / 2;

                    const windowHeight = top.window.innerHeight - headerHeight - paddinHeight - pageTitleHeight - footerHeight;
                    iframe.style.height = `${Math.max(iframeHeight, windowHeight)}px`;

					if($("#settingsWindow").contents().find(".textarea_ssh_table")) {
						const logMenuHeight = $("#settingsWindow").contents().find(".submenuBlock").height();
						const logAreaHeight = $("#settingsWindow").contents().find(".FormTitle").height();
						var logCurrentHeight = logAreaHeight + logMenuHeight;

						if($("#settingsWindow").height() > logCurrentHeight){
							$("#settingsWindow").contents().find(".textarea_ssh_table").css({
								"height": `${$("#settingsWindow").contents().find(".textarea_ssh_table").height() + windowHeight - logCurrentHeight}px`
							});
						}
					}
				}
			}
		});
	</script>
</html>
